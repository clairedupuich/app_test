name: Backend API Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Step 1️⃣ 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2️⃣ 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3️⃣ 安装依赖
      - name: Install dependencies
        run: npm install

      # Step 4️⃣ 启动后端服务
      - name: Start backend server
        run: npm start &
        env:
          PORT: 5000

      # Step 5️⃣ 等待 API 服务启动
      - name: Wait for server to be ready
        run: |
          echo "⏳ Waiting for http://localhost:5000 ..."
          for i in {1..10}; do
            if curl -s http://localhost:5000 > /dev/null; then
              echo "✅ Server is ready!"
              exit 0
            fi
            echo "Still waiting..."
            sleep 3
          done
          echo "❌ Server did not start in time." && exit 1

      # Step 6️⃣ 执行 Postman / Newman API 测试
      - name: Run Newman tests
        run: |
          mkdir -p reports
          npx newman run ./postman/prof_collection.json \
            --environment ./postman/prof_environment.json \
            -r htmlextra \
            --reporter-htmlextra-export ./reports/api-test-report.html

      # Step 7️⃣ 上传报告为 GitHub Artifact（可在 Actions 页面下载）
      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: reports/api-test-report.html

      # Step 8️⃣ 自动发布报告到 GitHub Pages
      - name: Deploy test report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
          keep_files: false
