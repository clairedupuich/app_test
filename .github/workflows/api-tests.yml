name: Newman API Tests

on:
  push:
    branches: [ main ]
  

jobs:
  run-api-test:
    runs-on: ubuntu-latest
    # timeout-minutes: 10

    steps:
      # Step 1️⃣ 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2️⃣ 设置 Node.js 环境
      - name: Installation de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Step 3️⃣ 安装依赖
      - name: Installation des dependencies
        run: npm install

      # Step 4️⃣ 启动后端服务
      - name: lancement du serveur
        run: |
          nohup node server.js > server.log 2>&1 &
          sleep 5

      # # Step 5️⃣ 等待 API 服务启动
      # - name: Wait for server to be ready
      #   run: |
      #     echo "⏳ Waiting for http://localhost:5000 ..."
      #     for i in {1..10}; do
      #       if curl -s http://localhost:5000 > /dev/null; then
      #         echo "✅ Server is ready!"
      #         exit 0
      #       fi
      #       echo "Still waiting..."
      #       sleep 3
      #     done
      #     echo "❌ Server did not start in time." && exit 1

      # # Step 6️⃣ 执行 Postman / Newman API 测试
      # - name: Run Newman tests
      #   run: |
      #     mkdir -p reports
      #     npx newman run ./postman/prof_collection.json \
      #       --environment ./postman/prof_environment.json \
      #       -r htmlextra \
      #       --reporter-htmlextra-export ./reports/api-test-report.html

      # # Step 7️⃣ 上传报告为 GitHub Artifact（可在 Actions 页面下载）
      # - name: Upload HTML report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: api-test-report
      #     path: reports/api-test-report.html
